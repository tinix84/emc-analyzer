<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMC Analyzer - Vue Prototype</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .status-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        .control-panel h3 {
            margin-bottom: 15px;
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .result-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        .result-panel h3 {
            color: #ffd700;
            margin-bottom: 15px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        .status.info { background: #2196F3; }
        
        .limit-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .limit-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .limit-item .label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .limit-item .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffd700;
        }
        
        pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üî¨ EMC Analyzer - Vue Prototype</h1>
                <p>WebAssembly-powered EMC compliance analysis tool</p>
                <div v-if="wasmStatus" :class="['status', wasmStatus.type]">
                    {{ wasmStatus.message }}
                </div>
            </div>

            <!-- WASM Status Panel -->
            <div class="status-panel">
                <h3>üöÄ WASM Status</h3>
                <button @click="initializeWasm" :disabled="loading">
                    {{ loading ? 'Loading...' : 'Initialize WASM' }}
                </button>
                <div v-if="wasmError" style="color: #ff6b6b; margin-top: 10px;">
                    ‚ùå {{ wasmError }}
                </div>
                <div v-if="wasmReady" style="color: #4CAF50; margin-top: 10px;">
                    ‚úÖ WASM Ready - {{ availableFunctions.length }} functions available
                </div>
            </div>

            <!-- Controls -->
            <div class="controls" v-if="wasmReady">
                <!-- Standard Selection -->
                <div class="control-panel">
                    <h3>üìã EMC Standard</h3>
                    <div class="form-group">
                        <label>Standard:</label>
                        <select v-model="selectedStandard">
                            <option value="CISPR22">CISPR 22</option>
                            <option value="EN55032">EN 55032</option>
                            <option value="ECE_R10_AC">ECE R10 AC</option>
                            <option value="ECE_R10_DC">ECE R10 DC</option>
                            <option value="IEC61800_3">IEC 61800-3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Class:</label>
                        <select v-model="selectedClass">
                            <option value="ClassA">Class A</option>
                            <option value="ClassB">Class B</option>
                            <option value="Class3">Class 3</option>
                            <option value="Class4">Class 4</option>
                        </select>
                    </div>
                    <button @click="loadStandard">Load Standard</button>
                </div>

                <!-- Frequency Analysis -->
                <div class="control-panel">
                    <h3>üì° Frequency Analysis</h3>
                    <div class="form-group">
                        <label>Frequency (MHz):</label>
                        <input type="number" v-model.number="testFrequency" min="0.1" max="1000" step="0.1">
                    </div>
                    <button @click="calculateLimit" :disabled="!currentStandard">Calculate Limit</button>
                </div>
            </div>

            <!-- Results -->
            <div class="results" v-if="wasmReady">
                <!-- Standard Info -->
                <div class="result-panel" v-if="currentStandard">
                    <h3>üìä Current Standard</h3>
                    <div><strong>Name:</strong> {{ currentStandard.name || 'Unknown' }}</div>
                    <div><strong>Frequency Points:</strong> {{ currentStandard.f_avg_limit_mask?.length || 0 }}</div>
                    <div class="limit-display" v-if="currentLimit">
                        <div class="limit-item">
                            <div class="label">AVG Limit</div>
                            <div class="value">{{ currentLimit.dbuv_avg_limit?.toFixed(1) || 'N/A' }} dB¬µV</div>
                        </div>
                        <div class="limit-item">
                            <div class="label">QP Limit</div>
                            <div class="value">{{ currentLimit.dbuv_qp_limit?.toFixed(1) || 'N/A' }} dB¬µV</div>
                        </div>
                        <div class="limit-item">
                            <div class="label">PK Limit</div>
                            <div class="value">{{ currentLimit.dbuv_pk_limit?.toFixed(1) || 'N/A' }} dB¬µV</div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="result-panel">
                    <h3>üìà EMC Limit Mask</h3>
                    <div class="chart-container">
                        <canvas id="emcChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Debug Info -->
            <div class="result-panel" v-if="debugInfo">
                <h3>üîß Debug Information</h3>
                <pre>{{ debugInfo }}</pre>
            </div>
        </div>
    </div>

    <script type="module">
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // WASM State
                const wasmModule = ref(null);
                const wasmReady = ref(false);
                const wasmError = ref(null);
                const wasmStatus = ref(null);
                const loading = ref(false);
                const availableFunctions = ref([]);

                // EMC State
                const selectedStandard = ref('CISPR22');
                const selectedClass = ref('ClassB');
                const testFrequency = ref(100);
                const currentStandard = ref(null);
                const currentLimit = ref(null);
                const debugInfo = ref('');

                // Chart
                let chart = null;

                const initializeWasm = async () => {
                    loading.value = true;
                    wasmError.value = null;
                    wasmStatus.value = { message: 'Initializing WASM...', type: 'info' };
                    
                    try {
                        console.log('üöÄ Starting WASM initialization...');
                        
                        // Import the WASM module
                        const wasmImport = await import('./public/wasm/emc_wasm.js');
                        console.log('‚úÖ WASM module imported');
                        
                        // Initialize and get the WASM object
                        const wasmObject = await wasmImport.default();
                        console.log('‚úÖ WASM object initialized:', wasmObject);
                        
                        // Store the WASM object
                        wasmModule.value = wasmObject;
                        availableFunctions.value = Object.keys(wasmObject).filter(k => typeof wasmObject[k] === 'function');
                        
                        wasmReady.value = true;
                        wasmStatus.value = { message: 'WASM Ready!', type: 'success' };
                        
                        debugInfo.value = `WASM Functions: ${availableFunctions.value.join(', ')}`;
                        
                    } catch (error) {
                        console.error('‚ùå WASM initialization failed:', error);
                        wasmError.value = error.message;
                        wasmStatus.value = { message: 'WASM Failed!', type: 'error' };
                    } finally {
                        loading.value = false;
                    }
                };

                const loadStandard = async () => {
                    if (!wasmModule.value) return;
                    
                    try {
                        console.log(`Loading standard: ${selectedStandard.value}, Class: ${selectedClass.value}`);
                        
                        const result = wasmModule.value.get_emc_standard(
                            selectedStandard.value, 
                            selectedClass.value, 
                            null
                        );
                        
                        console.log('‚úÖ Raw WASM result:', result);
                        console.log('Result type:', typeof result);
                        console.log('Result is array:', Array.isArray(result));
                        
                        // The WASM function might be returning serialized data that needs parsing
                        let standard;
                        if (Array.isArray(result)) {
                            // This looks like a Result<T, E> from Rust - [ok_flag, data_ptr, error_ptr]
                            if (result[0] === 0) {
                                // Success case - try to get the actual data
                                console.log('WASM returned success flag, but data needs extraction');
                                // For now, create a mock standard to test the UI
                                standard = {
                                    name: `${selectedStandard.value} ${selectedClass.value}`,
                                    f_avg_limit_mask: [
                                        0.15e6, 0.5e6, 5e6, 30e6, 100e6, 1000e6  // Hz
                                    ],
                                    dbuv_avg_limit_mask: [
                                        79, 73, 73, 40, 40, 47  // dB¬µV
                                    ],
                                    f_qp_limit_mask: null,
                                    dbuv_qp_limit_mask: null,
                                    f_pk_limit_mask: null,
                                    dbuv_pk_limit_mask: null
                                };
                                console.log('üìù Using mock standard data for UI testing');
                            } else {
                                throw new Error(`WASM function returned error: ${result[2]}`);
                            }
                        } else if (typeof result === 'object' && result.name) {
                            // Already a proper object
                            standard = result;
                        } else {
                            throw new Error(`Unexpected result format: ${typeof result}`);
                        }
                        
                        currentStandard.value = standard;
                        console.log('‚úÖ Standard processed:', standard);
                        
                        // Wait for DOM update then generate chart
                        await new Promise(resolve => setTimeout(resolve, 100));
                        generateChart();
                        
                    } catch (error) {
                        console.error('‚ùå Failed to load standard:', error);
                        wasmError.value = `Failed to load standard: ${error.message}`;
                    }
                };

                const calculateLimit = async () => {
                    if (!wasmModule.value || !currentStandard.value) return;
                    
                    try {
                        const standardJson = JSON.stringify(currentStandard.value);
                        const frequencyHz = testFrequency.value * 1e6; // Convert MHz to Hz
                        
                        const result = wasmModule.value.calculate_emc_limit(standardJson, frequencyHz);
                        currentLimit.value = result;
                        
                        console.log('‚úÖ Limit calculated:', result);
                        
                    } catch (error) {
                        console.error('‚ùå Failed to calculate limit:', error);
                        wasmError.value = `Failed to calculate limit: ${error.message}`;
                    }
                };

                const generateChart = () => {
                    console.log('üé® Starting generateChart()');
                    console.log('currentStandard.value:', currentStandard.value);
                    
                    if (!currentStandard.value) {
                        console.log('‚ùå No current standard, cannot generate chart');
                        return;
                    }
                    
                    const ctx = document.getElementById('emcChart');
                    console.log('Canvas element:', ctx);
                    if (!ctx) {
                        console.log('‚ùå Canvas element not found');
                        return;
                    }
                    
                    // Destroy existing chart
                    if (chart) {
                        console.log('üóëÔ∏è Destroying existing chart');
                        chart.destroy();
                    }
                    
                    const standard = currentStandard.value;
                    console.log('Standard data:', {
                        name: standard.name,
                        f_avg_mask: standard.f_avg_limit_mask,
                        dbuv_avg_mask: standard.dbuv_avg_limit_mask
                    });
                    
                    if (!standard.f_avg_limit_mask || !standard.dbuv_avg_limit_mask) {
                        console.log('‚ùå Missing frequency or limit data');
                        return;
                    }
                    
                    const freqs = standard.f_avg_limit_mask.map(f => f / 1e6); // Convert to MHz
                    const limits = standard.dbuv_avg_limit_mask;
                    
                    console.log('Chart data:', {
                        frequencies: freqs.slice(0, 5),
                        limits: limits.slice(0, 5),
                        totalPoints: freqs.length
                    });
                    
                    try {
                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: freqs.map(f => f.toFixed(1)),
                                datasets: [{
                                    label: 'AVG Limit (dB¬µV)',
                                    data: limits,
                                    borderColor: '#4CAF50',
                                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${standard.name} - EMC Limit Mask`
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Frequency (MHz)'
                                        },
                                        type: 'logarithmic'
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Limit (dB¬µV)'
                                        }
                                    }
                                }
                            }
                        });
                        console.log('‚úÖ Chart created successfully:', chart);
                    } catch (error) {
                        console.error('‚ùå Chart creation failed:', error);
                    }
                };

                // Auto-initialize WASM on mount
                onMounted(() => {
                    initializeWasm();
                });

                return {
                    // WASM
                    wasmReady,
                    wasmError,
                    wasmStatus,
                    loading,
                    availableFunctions,
                    initializeWasm,
                    
                    // EMC
                    selectedStandard,
                    selectedClass,
                    testFrequency,
                    currentStandard,
                    currentLimit,
                    loadStandard,
                    calculateLimit,
                    
                    // Debug
                    debugInfo
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
